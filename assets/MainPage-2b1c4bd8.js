import{_ as E,u as H,l as R,E as O,g as w,a as B,b as L,c as X,d as j,F as I,e as G,r as b,f as K,o as c,h as p,i as o,w as r,j as J,k as U,m as A,n as M,p as f,q as D,s as C,t as u,v as m,x as Q,y as Y,z as Z,A as $}from"./index-87936d70.js";import{U as y,C as tt,m as et,a as at,b as it}from"./ContractHelper-bc54eede.js";import{s as F,C as z,_ as V}from"./stx-icon-45e3c94e.js";const nt=$(),_=J(),st={name:"MainPage",components:{},data(){return{kLoadMempoolInterval:12e3,bSignedIn:H.isUserSignedIn(),refreshTip:"Please refresh page.",curWrapperToken:"Wsbtc",wrapperList:["Wsbtc"],activeTabName:"listings",sortMethod:"priceunit-0",sortMethods:[{value:"priceunit-0",label:"Price: From Low to High"},{value:"priceunit-1",label:"Price: From High to Low"},{value:"block-1",label:"List time: From Latest to Earliest"},{value:"block-0",label:"List time: From Earliest to Latest"}],listingData:{curWrapperToken:"",bLoadFinishFlag:!1,bDivLoading:!1,kPageSize:20,totalCount:-1,curPage:1,loadState:0,tableData:[]},activityDatas:{curWrapperToken:"",kPageSize:25,totalCount:-1,curPage:1,loadState:0,tableData:[]},mempoolTickHandle:null,mempoolLoadingID:0,mempoolTxDict:{}}},async mounted(){this.listingData.curWrapperToken=this.curWrapperToken,this.activityDatas.curWrapperToken=this.curWrapperToken,this.loadMempoolTransactions(),this.loadListingPage(1)},methods:{async loadListingPage(a,t){this.listingData.bDivLoading=t,this.listingData.curPage=a,this.listingData.loadState=1;const i=(a-1)*this.listingData.kPageSize,s=i+this.listingData.kPageSize-1,e=this.sortMethod.split("-"),l=e[0],d=e[1]=="0",h=a,{data:g,error:S,status:P,count:T}=await F.from("listings").select("*",{count:"exact"}).eq("state",1).order(l,{ascending:d}).range(i,s);this.listingData.bDivLoading=!1,this.listingData.loadState=2,this.listingData.bLoadFinishFlag=!0,h==this.listingData.curPage&&(S?(console.log("loadListingPage error: ",{error:S,status:P,data:g,count:T}),y.alert("load page error")):(this.listingData.totalCount=T,this.setListingTableData(g)))},async setListingTableData(a){this.listingData.tableData.splice(0,this.listingData.tableData.length);for(const t of a){const[i,s]=this.calcPriceUnit(BigInt(t.priceunit));this.listingData.tableData.push({orderId:t.orderid,state:t.state,block:t.block,wrapperTokenName:t.wrapper,seller:t.seller,amount:BigInt(t.amount),price:BigInt(t.price),priceUnitStr:i,bPriceUnitSup:s,bPending:!1,bReqBuying:!1})}},async loadActivityPage(a){this.activityDatas.curPage=a,this.activityDatas.loadState=1;const t=(a-1)*this.activityDatas.kPageSize,i=t+this.activityDatas.kPageSize-1,s=a,{data:e,error:l,status:d,count:h}=await F.from("activity").select("*",{count:"exact"}).order("block",{ascending:!1}).range(t,i);this.activityDatas.loadState=2,s==this.activityDatas.curPage&&(l?(console.log("loadListingPage error: ",{error:l,status:d,data:e,count:h}),y.alert("load page error")):(this.activityDatas.totalCount=h,this.setActivityTableData(e)))},async setActivityTableData(a){this.activityDatas.tableData.splice(0,this.activityDatas.tableData.length);for(const t of a){const[i,s]=this.calcPriceUnit(BigInt(t.priceunit));this.activityDatas.tableData.push({orderId:t.orderid,timeStr:y.formatTime(t.stamp),wrapperTokenName:t.wrapper,seller:t.seller,briefSeller:y.getBriefAddress(t.seller),amount:BigInt(t.amount),price:BigInt(t.price),priceUnitStr:i,bPriceUnitSup:s,buyer:t.buyer,briefBuyer:y.getBriefAddress(t.buyer)})}},calcPriceUnit(a){const t=a.toString();let[i,s]=[!1,null];if(t.length<=14)14-t.length<6?i="0."+"0".repeat(14-t.length)+t.substr(0,3).replace(/(0+)$/g,""):(s=!0,i="0."+"0".repeat(8-t.length)+t.substr(0,3).replace(/(0+)$/g,""));else{i=t.substring(0,t.length-14);let e=t.substring(t.length-14).replace(/(0+)$/g,"");e.length>0&&(e=e.substr(0,4).replace(/(0+)$/g,""),e!=""?i=i+"."+e:i=i+".0001")}return[i,s]},onChangeToken(){},async onClickBuy(a){if(!this.bSignedIn){R();return}const t=this.listingData.tableData[a];if(!t)return;const i=this.mempoolTxDict[t.orderId.toString()];if(i){let s=this;const e=this.generatePendingTip(i);O.confirm(e,"Warning",{confirmButtonText:"Continue to buy",cancelButtonText:"Cancel",type:"warning",dangerouslyUseHTMLString:!0}).then(()=>{s.realBuy(t)})}else this.realBuy(t)},generatePendingTip(a){if(a.length==1)return`<div style="color:#dd0">Find pending tx(<a href='${`https://explorer.hiro.so/txid/${a[0].txId}?chain=${w()}`}' style="color:#dd0" target="_blank">click to view</a>), your may fail if continue to buy!</div>`;{let t=[];t.push('<div style="color:#dd0">Find multiple pending txs, your may fail if continue to buy!</div>');for(let i=0;i<a.length;i++){const e=`https://explorer.hiro.so/txid/${a[i].txId}?chain=${w()}`;t.push(`<div style="color:#dd0">${i+1}. <a href='${e}' style="color:#dd0" target="_blank">click to view</a></div>`)}return t.join("")}},async realBuy(a){a.bReqBuying=!0;const t=await tt.queryListing(a.orderId);if(!t){a.bReqBuying=!1,y.alert(`Order(id=${a.orderId}) not exists! ${this.refreshTip}`);return}if(t.seller.toUpperCase()==B().toUpperCase()){a.bReqBuying=!1,y.alert("Cannot buy self!");return}if(t.state!=1){a.bReqBuying=!1,y.alert(`Order(id=${a.orderId}) not valid(status=${t.state})! ${this.refreshTip}`);return}const i=t.wrapper.split(".");if(a.wrapperTokenName!=i[1]||a.amount!=t.amount||a.price!=t.price){a.bReqBuying=!1,console.log("Order mismatch"[t]),y.alert(`Order mismatch! ${this.refreshTip}`);return}let s=await z.getAccountBalance(B());if(a.bReqBuying=!1,s<=a.price){y.alert("Balance unenough!");return}const e=parseInt(a.price);if(e&&s<=5e6+e){let l=this;this.$confirm(`Balance: ${s/1e6} STX, price: ${e/1e6} STX, fee must less than ${(s-e)/1e6} STX!`,"Attention",{confirmButtonText:"Got it",cancelButtonText:"Cancel",type:"warning"}).then(()=>{l.doBuy(a,t,i)})}else this.doBuy(a,t,i)},doBuy(a,t,i){const s=[L(a.orderId),X(i[0],i[1]),L(a.amount),L(a.price)],e=j(i[0],i[1],i[1]);let l=[];l.push(et(B(),I.LessEqual,a.price)),l.push(at(_.defaultContractAddress,_.marketContract.name,I.LessEqual,a.price)),l.push(it(_.defaultContractAddress,_.marketContract.name,I.Equal,BigInt(a.amount*1000000n),e));let d=this;const h={contractAddress:_.defaultContractAddress,contractName:_.marketContract.name,functionName:"buy",functionArgs:s,network:nt,appDetails:Q(),postConditions:l,onFinish:g=>{setTimeout(()=>{d.loadMempoolTransactions()},500),z.tipTxid(g.txId,"Buy transaction has been sent.")}};G(h)},onChangeTab(){this.activeTabName=="listings"?this.loadListingPage(1,!0):this.activeTabName=="activity"&&this.loadActivityPage(1)},async loadMempoolTransactions(){this.mempoolTickHandle&&(clearTimeout(this.mempoolTickHandle),this.mempoolTickHandle=null);let a=this;this.mempoolTickHandle=setTimeout(()=>{a.loadMempoolTransactions()},this.kLoadMempoolInterval);const t=++this.mempoolLoadingID;let i={};const s=await this.realLoadMempoolTransactions(50,0,i);if(s>50&&t==this.mempoolLoadingID&&(await this.realLoadMempoolTransactions(50,50,i),s>100&&t==this.mempoolLoadingID&&await this.realLoadMempoolTransactions(50,100,i)),t==this.mempoolLoadingID){this.mempoolTxDict={};for(const[e,l]of Object.entries(i))this.mempoolTxDict[e]=l}},async realLoadMempoolTransactions(a,t,i){const s=`${_.defaultContractAddress}.${_.marketContract.name}`,e=await z.loadMempoolTxs(s,a,t,!0);for(const l of e.results){if(l.tx_type!="contract_call")continue;const d=l.contract_call;if(d.function_name=="change_price"||d.function_name=="cancel_list"||d.function_name=="buy"){const g=d.function_args[0].repr.substr(1);i[g]||(i[g]=[]),i[g].push({function_name:d.function_name,txId:l.tx_id})}}},_inGetNetType(){return w()}}},k=a=>(Y("data-v-29c6b94e"),a=a(),Z(),a),lt={id:"main"},ot=k(()=>u("span",{id:"selTip"},"Select token:",-1)),rt={id:"listArea","element-loading-background":"rgba(0, 0, 0, 0.4)"},ct={class:"listAmount"},ut=k(()=>u("img",{src:V,width:"20",height:"20"},null,-1)),dt={class:"priceUnit"},gt={key:0},pt=k(()=>u("sup",null,"-6",-1)),mt={class:"buyFont"},ht={key:0,class:"pendingTip"},bt={key:0,id:"emptyListing"},yt={key:1,"element-loading-background":"rgba(0, 0, 0, 0)",style:{height:"300px","margin-top":"32px"}},_t={key:2,class:"pagiArea"},ft={class:"contentCol"},Dt=k(()=>u("img",{src:V,width:"20",height:"20"},null,-1)),vt={class:"contentCol"},Tt={key:0},kt=k(()=>u("sup",null,"-6",-1)),St=["href"],Ct=["href"],Pt={class:"contentCol"},xt={key:0,class:"pagiArea"};function wt(a,t,i,s,e,l){const d=b("el-option"),h=b("el-select"),g=b("el-space"),S=b("el-button"),P=b("el-card"),T=b("el-pagination"),N=b("el-tab-pane"),v=b("el-table-column"),q=b("el-table"),W=b("el-tabs"),x=K("loading");return c(),p("div",lt,[o(g,{alignment:"center",style:{"margin-top":"8px"}},{default:r(()=>[ot,o(h,{modelValue:e.curWrapperToken,"onUpdate:modelValue":t[0]||(t[0]=n=>e.curWrapperToken=n),size:"large",filterable:"",placeholder:"Select",style:{width:"200px"},onChange:l.onChangeToken},{default:r(()=>[(c(!0),p(U,null,A(e.wrapperList,n=>(c(),C(d,{key:n,label:n,value:n},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onChange"])]),_:1}),o(W,{modelValue:e.activeTabName,"onUpdate:modelValue":t[7]||(t[7]=n=>e.activeTabName=n),size:"large",style:{"margin-top":"32px"},onTabChange:l.onChangeTab},{default:r(()=>[o(N,{label:"Listed",name:"listings"},{default:r(()=>[o(g,{alignment:"center",style:{"margin-top":"8px"}},{default:r(()=>[o(h,{modelValue:e.sortMethod,"onUpdate:modelValue":t[1]||(t[1]=n=>e.sortMethod=n),size:"large",filterable:"",placeholder:"",style:{width:"240px"},onChange:t[2]||(t[2]=n=>l.loadListingPage(1,!0))},{default:r(()=>[(c(!0),p(U,null,A(e.sortMethods,n=>(c(),C(d,{key:n.value,label:n.label,value:n.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),M((c(),p("div",rt,[(c(!0),p(U,null,A(e.listingData.tableData.length,n=>(c(),C(P,{key:n,shadow:"hover",class:"cardArea","body-style":{padding:"8px"}},{default:r(()=>[o(g,{direction:"vertical",alignment:"center"},{default:r(()=>[u("div",ct,m(e.listingData.tableData[n-1].amount),1),o(g,{class:"list-stx"},{default:r(()=>[ut,D(" "+m(e.listingData.tableData[n-1].price/1000000n),1)]),_:2},1024),u("div",dt,[D(m(e.listingData.tableData[n-1].priceUnitStr)+" ",1),e.listingData.tableData[n-1].bPriceUnitSup?(c(),p("label",gt,[D(" x 10"),pt])):f("",!0),u("span",null," STX/"+m(e.listingData.curWrapperToken),1)]),o(S,{class:"buyBtn",loading:e.listingData.tableData[n-1].bReqBuying,size:"large",type:"primary",onClick:Bt=>l.onClickBuy(n-1)},{default:r(()=>[u("span",mt,m(e.bSignedIn?"Buy":"Sign in to buy"),1)]),_:2},1032,["loading","onClick"]),e.mempoolTxDict[e.listingData.tableData[n-1].orderId.toString()]?(c(),p("div",ht,"Pending..")):f("",!0)]),_:2},1024)]),_:2},1024))),128))])),[[x,e.listingData.bDivLoading]]),e.listingData.loadState==2&&e.listingData.tableData.length==0?(c(),p("div",bt,"No listings")):f("",!0),e.listingData.loadState==1&&!e.listingData.bLoadFinishFlag?M((c(),p("div",yt,[D(" ")])),[[x,!0]]):f("",!0),e.listingData.totalCount>e.listingData.kPageSize?(c(),p("div",_t,[o(T,{disabled:e.listingData.loadState!=2,layout:"total, prev, pager, next, jumper","default-page-size":e.listingData.kPageSize,"current-page":e.listingData.curPage,"onUpdate:currentPage":t[3]||(t[3]=n=>e.listingData.curPage=n),total:e.listingData.totalCount,onCurrentChange:t[4]||(t[4]=n=>l.loadListingPage(e.listingData.curPage,!0))},null,8,["disabled","default-page-size","current-page","total"])])):f("",!0)]),_:1}),o(N,{label:"Activity",name:"activity"},{default:r(()=>[M((c(),C(q,{stripe:"",style:{width:"100%"},size:"large",data:e.activityDatas.tableData,"element-loading-background":"rgba(0, 0, 0, 0.4)","empty-text":e.activityDatas.loadState==2?"Empty":" "},{default:r(()=>[o(v,{label:"Amount",width:"120"},{default:r(n=>[u("div",ft,m(n.row.amount),1)]),_:1}),o(v,{label:"Price",width:"120"},{default:r(n=>[o(g,{class:"contentCol"},{default:r(()=>[Dt,D(" "+m(n.row.price/1000000n),1)]),_:2},1024)]),_:1}),o(v,{label:"Price unit",width:"230"},{default:r(n=>[u("div",vt,[D(m(n.row.priceUnitStr)+" ",1),n.row.bPriceUnitSup?(c(),p("label",Tt,[D(" x 10"),kt])):f("",!0),u("span",null," STX/"+m(e.activityDatas.curWrapperToken),1)])]),_:1}),o(v,{label:"Seller",width:"150px"},{default:r(n=>[u("a",{href:"https://explorer.hiro.so/address/"+n.row.seller+"?chain="+l._inGetNetType(),target:"_blank"},m(n.row.briefSeller),9,St)]),_:1}),o(v,{label:"Buyer",width:"150px"},{default:r(n=>[u("a",{href:"https://explorer.hiro.so/address/"+n.row.buyer+"?chain="+l._inGetNetType(),target:"_blank"},m(n.row.briefBuyer),9,Ct)]),_:1}),o(v,{label:"Time"},{default:r(n=>[u("div",Pt,m(n.row.timeStr),1)]),_:1})]),_:1},8,["data","empty-text"])),[[x,e.activityDatas.loadState==1]]),e.activityDatas.totalCount>e.activityDatas.kPageSize?(c(),p("div",xt,[o(T,{disabled:e.activityDatas.loadState!=2,layout:"total, prev, pager, next, jumper","default-page-size":e.activityDatas.kPageSize,"current-page":e.activityDatas.curPage,"onUpdate:currentPage":t[5]||(t[5]=n=>e.activityDatas.curPage=n),total:e.activityDatas.totalCount,onCurrentChange:t[6]||(t[6]=n=>l.loadActivityPage(e.activityDatas.curPage))},null,8,["disabled","default-page-size","current-page","total"])])):f("",!0)]),_:1})]),_:1},8,["modelValue","onTabChange"])])}const At=E(st,[["render",wt],["__scopeId","data-v-29c6b94e"]]);export{At as default};
