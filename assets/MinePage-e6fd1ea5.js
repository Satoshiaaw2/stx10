import{_ as K,u as O,a as P,l as Q,c as T,b as f,d as X,F as j,e as B,g as R,B as Z,r as p,f as $,o as D,h as _,s as v,w as l,p as S,i as n,j as tt,k as et,m as at,t as c,v as u,q as d,n as L,x as V,y as it,z as lt,C as nt,A as st}from"./index-ce65770f.js";import{C as rt,c as ot,U as A,b as ct}from"./ContractHelper-e2a73833.js";import{s as G,C as I,_ as H}from"./stx-icon-f91b53c1.js";const N=st(),g=tt(),ut={name:"MinePage",components:{},computed:{listBtnEnabled(){this.listDialogData.amountStr=this.listDialogData.amountStr.trim();const i=this.listDialogData.amountStr;if(!/^[0-9]{1,16}$/i.test(i))return!1;const t=BigInt(i);if(t<=0n)return!1;if(this.listDialogData.listType==1){if(t>this.balanceData.stx10Balance)return!1}else if(this.listDialogData.listType==2){if(t*1000000n>this.balanceData.sip10Balance)return!1}else return!1;this.listDialogData.priceStr=this.listDialogData.priceStr.trim();const s=this.listDialogData.priceStr;if(!/^[0-9]{1,16}$/i.test(s))return!1;const o=BigInt(s);return!(o<1n||o>1000000n||o/t>1000n)},changePriceBtnEnabled(){this.changePriceDialogData.priceStr=this.changePriceDialogData.priceStr.trim();const i=this.changePriceDialogData.priceStr;if(!/^[0-9]{1,16}$/i.test(i))return!1;const t=BigInt(i);return!(t<1n||t>1000000n||t/BigInt(this.changePriceDialogData.amountStr)>1000n)}},data(){return{bSignedIn:O.isUserSignedIn(),activeTabName:"balance",sip10NameList:["Wsbtc"],balanceData:{curStx10Name:"sbtc",curSip10Name:"Wsbtc",loadState:0,stx10Balance:0n,sip10Balance:0n},listingData:{curWrapperToken:"Wsbtc",kPageSize:25,totalCount:-1,curPage:1,loadState:0,tableData:[]},activityDatas:{curWrapperToken:"Wsbtc",kPageSize:25,totalCount:-1,curPage:1,loadState:0,tableData:[]},listDialogData:{bVisible:!1,listType:0,title:"--",amountStr:"",priceStr:""},changePriceDialogData:{bVisible:!1,orderInfo:null,amountStr:"",priceStr:""}}},async mounted(){this.bSignedIn&&this.loadBalance()},methods:{async loadBalance(){this.balanceData.loadState=1;const i=await rt.queryWrapSummary(this.balanceData.curStx10Name,P());this.balanceData.loadState=2,this.balanceData.stx10Balance=i.stx10Balance,this.balanceData.sip10Balance=i.sip10Balance},onClickSignIn(){Q()},async onClickWrapAndList(){this.listDialogData.bVisible=!0,this.listDialogData.listType=1,this.listDialogData.title="Wrap and list",this.listDialogData.priceStr="",this.setAmountMax()},async onClickList(){this.listDialogData.bVisible=!0,this.listDialogData.listType=2,this.listDialogData.title="List",this.listDialogData.priceStr="",this.setAmountMax()},onClickListMax(){this.setAmountMax()},setAmountMax(){this.listDialogData.listType==1?this.listDialogData.amountStr=this.balanceData.stx10Balance.toString():this.listDialogData.listType==2&&(this.listDialogData.amountStr=(this.balanceData.sip10Balance/1000000n).toString())},onClickDialogList(){let i=null;const t=[T(g.defaultWrapperContractAddress,this.balanceData.curSip10Name),f(this.listDialogData.amountStr),f(BigInt(this.listDialogData.priceStr)*1000000n)];if(this.listDialogData.listType==1)i="wrap_and_list_token";else if(this.listDialogData.listType==2)i="list_token";else return;const s=X(g.defaultWrapperContractAddress,this.balanceData.curSip10Name,this.balanceData.curSip10Name);let o=[];o.push(ot(P(),j.Equal,BigInt(BigInt(this.listDialogData.amountStr)*1000000n),s));const e={contractAddress:g.defaultContractAddress,contractName:g.marketContract.name,functionName:i,functionArgs:t,network:N,appDetails:V(),postConditions:o,onFinish:r=>{this.listDialogData.bVisible=!1,I.tipTxid(r.txId,"List transaction has been sent.")}};B(e)},async loadListingPage(i){this.listingData.curPage=i,this.listingData.loadState=1;const t=(i-1)*this.listingData.kPageSize,s=t+this.listingData.kPageSize-1,o=i,{data:e,error:r,status:y,count:C}=await G.from("listings").select("*",{count:"exact"}).eq("state",1).eq("seller",P()).order("block",{ascending:!1}).range(t,s);this.listingData.loadState=2,o==this.listingData.curPage&&(r?(console.log("loadListingPage error: ",{error:r,status:y,data:e,count:C}),A.alert("load page error")):(this.listingData.totalCount=C,this.setListingTableData(e)))},async setListingTableData(i){this.listingData.tableData.splice(0,this.listingData.tableData.length);for(const t of i){const[s,o]=this.calcPriceUnit(BigInt(t.priceunit));this.listingData.tableData.push({orderId:t.orderid,state:t.state,block:t.block,wrapperTokenName:t.wrapper,seller:t.seller,amount:BigInt(t.amount),price:BigInt(t.price),priceUnitStr:s,bPriceUnitSup:o,bPending:!1})}},async onClickChangePrice(i){this.changePriceDialogData.bVisible=!0,this.changePriceDialogData.orderInfo=i,this.changePriceDialogData.amountStr=i.amount.toString(),this.changePriceDialogData.priceStr=(i.price/1000000n).toString()},async onClickDialogChangePrice(){const i=this.changePriceDialogData.orderInfo;if(this.changePriceDialogData.priceStr==(i.price/1000000n).toString())return;let t="change_price";const s=[f(i.orderId),T(g.defaultWrapperContractAddress,this.balanceData.curSip10Name),f(i.amount),f(BigInt(this.changePriceDialogData.priceStr)*1000000n)];let o=[];const e={contractAddress:g.defaultContractAddress,contractName:g.marketContract.name,functionName:t,functionArgs:s,network:N,appDetails:V(),postConditions:o,onFinish:r=>{this.changePriceDialogData.bVisible=!1,I.tipTxid(r.txId,"Change price transaction has been sent.")}};B(e)},async onClickCancel(i){let t=this;this.$confirm("Are you sure to cancel list it?","Attention",{confirmButtonText:"Yes",cancelButtonText:"Cancel",type:"warning"}).then(()=>{t.sureCancelList(i)})},async sureCancelList(i){let t="cancel_list";const s=[f(i.orderId),T(g.defaultWrapperContractAddress,this.listingData.curWrapperToken),f(i.amount),f(i.price)];let o=[];const e=X(g.defaultWrapperContractAddress,this.listingData.curWrapperToken,this.listingData.curWrapperToken);o.push(ct(g.defaultContractAddress,g.marketContract.name,j.Equal,BigInt(i.amount*1000000n),e));const r={contractAddress:g.defaultContractAddress,contractName:g.marketContract.name,functionName:t,functionArgs:s,network:N,appDetails:V(),postConditions:o,onFinish:y=>{this.changePriceDialogData.bVisible=!1,I.tipTxid(y.txId,"Cancel list transaction has been sent.")}};B(r)},async loadActivityPage(i){this.activityDatas.curPage=i,this.activityDatas.loadState=1;const t=(i-1)*this.activityDatas.kPageSize,s=t+this.activityDatas.kPageSize-1,o=i,{data:e,error:r,status:y,count:C}=await G.from("activity").select("*",{count:"exact"}).or(`seller.eq.${P()},buyer.eq.${P()}`).order("block",{ascending:!1}).range(t,s);this.activityDatas.loadState=2,o==this.activityDatas.curPage&&(r?(console.log("loadActivityPage error: ",{error:r,status:y,data:e,count:C}),A.alert("load page error")):(this.activityDatas.totalCount=C,this.setActivityTableData(e)))},async setActivityTableData(i){this.activityDatas.tableData.splice(0,this.activityDatas.tableData.length);const t=P();for(const s of i){const[o,e]=this.calcPriceUnit(BigInt(s.priceunit));this.activityDatas.tableData.push({orderId:s.orderid,timeStr:A.formatTime(s.stamp),wrapperTokenName:s.wrapper,seller:s.seller,briefSeller:t==s.seller?"Me":A.getBriefAddress(s.seller),amount:BigInt(s.amount),price:BigInt(s.price),priceUnitStr:o,bPriceUnitSup:e,buyer:s.buyer,briefBuyer:t==s.buyer?"Me":A.getBriefAddress(s.buyer)})}},calcPriceUnit(i){const t=i.toString();let[s,o]=[!1,null];return t.length<=14?14-t.length<6?s="0."+"0".repeat(14-t.length)+t.substr(0,2).replace(/(0+)$/g,""):(o=!0,s="0."+"0".repeat(8-t.length)+t.substr(0,1)):(s=t.substring(0,t.length-14)+"."+t.substring(t.length-14).replace(/(0+)$/g,""),s.endsWith(".")&&(s=s.substr(0,s.length-1))),[s,o]},onChangeTab(){this.bSignedIn&&(this.activeTabName=="balance"?this.loadBalance():this.activeTabName=="listing"?this.loadListingPage(1):this.activeTabName=="activity"&&this.loadActivityPage(1))},_inGetNetType(){return R()},onClickAddPair(){let i="add_tick_wrapper_pair";const t=[Z("sbtc"),T(g.defaultWrapperContractAddress,this.balanceData.curSip10Name)];let s=[];const o={contractAddress:g.defaultContractAddress,contractName:g.marketContract.name,functionName:i,functionArgs:t,network:N,appDetails:V(),postConditions:s,onFinish:e=>{I.tipTxid(e.txId,"Add tick wrapper pair transaction has been sent.")}};B(o)}}},h=i=>(it("data-v-507499ac"),i=i(),lt(),i),dt={id:"main"},gt=h(()=>c("span",{id:"selTip"},"Select token:",-1)),pt=h(()=>c("p",null,null,-1)),Dt={key:0,direction:"vertical",id:"balanceValueArea"},ht={class:"tokenName"},mt={class:"tokenAmount"},bt=h(()=>c("img",{src:nt,width:"20",height:"20"},null,-1)),ft={class:"tokenAmount"},_t={key:1,"element-loading-background":"rgba(0, 0, 0, 0)",style:{"text-align":"left","margin-top":"32px",height:"80px",width:"100px"}},St={class:"contentCol"},yt=h(()=>c("img",{src:H,width:"20",height:"20"},null,-1)),Ct={class:"contentCol"},kt={key:0},Pt=h(()=>c("sup",null,"-6",-1)),vt={key:0,class:"pagiArea"},At={class:"contentCol"},xt=h(()=>c("img",{src:H,width:"20",height:"20"},null,-1)),wt={class:"contentCol"},Tt={key:0},Bt=h(()=>c("sup",null,"-6",-1)),Vt=["href"],It=["href"],Nt={class:"contentCol"},Ut={key:0,class:"pagiArea"},zt=h(()=>c("span",{class:"wrapperTip"},"Amount:",-1)),Lt=h(()=>c("span",{class:"wrapperTip"},"Price:",-1)),Wt=h(()=>c("span",{class:"wrapperTip"},"Amount:",-1)),Mt=h(()=>c("span",{class:"wrapperTip"},"Price:",-1));function Et(i,t,s,o,e,r){const y=p("el-option"),C=p("el-select"),x=p("el-space"),b=p("el-button"),W=p("el-card"),U=p("el-tab-pane"),m=p("el-table-column"),M=p("el-table"),E=p("el-pagination"),Y=p("el-tabs"),w=p("el-input"),k=p("el-form-item"),F=p("el-form"),q=p("el-dialog"),z=$("loading");return D(),_("div",dt,[e.bSignedIn?(D(),v(Y,{key:0,modelValue:e.activeTabName,"onUpdate:modelValue":t[7]||(t[7]=a=>e.activeTabName=a),size:"large",style:{"margin-top":"32px","text-align":"left"},onTabChange:r.onChangeTab},{default:l(()=>[n(U,{label:"Balance",name:"balance"},{default:l(()=>[n(x,{alignment:"center",style:{"margin-top":"8px"}},{default:l(()=>[gt,n(C,{modelValue:e.balanceData.curSip10Name,"onUpdate:modelValue":t[0]||(t[0]=a=>e.balanceData.curSip10Name=a),size:"large",filterable:"",placeholder:"Select",style:{width:"200px"}},{default:l(()=>[(D(!0),_(et,null,at(e.sip10NameList,a=>(D(),v(y,{key:a,label:a,value:a},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),pt,e.balanceData.loadState==2?(D(),_("div",Dt,[n(W,{shadow:"hover",class:"cardArea","body-style":{padding:"8px"}},{default:l(()=>[c("div",ht,u(e.balanceData.curStx10Name),1),c("div",mt,u(e.balanceData.stx10Balance),1),n(b,{class:"tokenBtn",type:"primary",disabled:e.balanceData.stx10Balance==0n,onClick:t[1]||(t[1]=a=>r.onClickWrapAndList())},{default:l(()=>[d("Wrap and list")]),_:1},8,["disabled"])]),_:1}),n(W,{shadow:"hover",class:"cardArea","body-style":{padding:"8px"}},{default:l(()=>[n(x,{class:"tokenName"},{default:l(()=>[bt,c("div",null,u(e.balanceData.curSip10Name),1)]),_:1}),c("div",ft,u(e.balanceData.sip10Balance/1000000n),1),n(b,{class:"tokenBtn",type:"primary",disabled:e.balanceData.sip10Balance==0n,onClick:t[2]||(t[2]=a=>r.onClickList())},{default:l(()=>[d("List")]),_:1},8,["disabled"])]),_:1})])):S("",!0),e.balanceData.loadState==1?L((D(),_("div",_t,null,512)),[[z,!0]]):S("",!0)]),_:1}),n(U,{label:"Listing",name:"listing"},{default:l(()=>[L((D(),v(M,{stripe:"",style:{width:"100%"},size:"large",data:e.listingData.tableData,"element-loading-background":"rgba(0, 0, 0, 0.4)","empty-text":e.listingData.loadState==2?"Empty":" "},{default:l(()=>[n(m,{label:"Amount",width:"150"},{default:l(a=>[c("div",St,u(a.row.amount),1)]),_:1}),n(m,{label:"Price",width:"120"},{default:l(a=>[n(x,{class:"contentCol"},{default:l(()=>[yt,d(" "+u(a.row.price/1000000n),1)]),_:2},1024)]),_:1}),n(m,{label:"Price unit",width:"250"},{default:l(a=>[c("div",Ct,[d(u(a.row.priceUnitStr)+" ",1),a.row.bPriceUnitSup?(D(),_("label",kt,[d(" x 10"),Pt])):S("",!0),c("span",null," STX/"+u(e.activityDatas.curWrapperToken),1)])]),_:1}),n(m,{label:"Action"},{default:l(a=>[n(b,{plain:"",onClick:J=>r.onClickChangePrice(a.row)},{default:l(()=>[d("Change price")]),_:2},1032,["onClick"]),n(b,{plain:"",onClick:J=>r.onClickCancel(a.row)},{default:l(()=>[d("Cancel list")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data","empty-text"])),[[z,e.listingData.loadState==1]]),e.listingData.totalCount>e.listingData.kPageSize?(D(),_("div",vt,[n(E,{disabled:e.listingData.loadState!=2,layout:"total, prev, pager, next, jumper","default-page-size":e.listingData.kPageSize,"current-page":e.listingData.curPage,"onUpdate:currentPage":t[3]||(t[3]=a=>e.listingData.curPage=a),total:e.listingData.totalCount,onCurrentChange:t[4]||(t[4]=a=>r.loadListingPage(e.listingData.curPage))},null,8,["disabled","default-page-size","current-page","total"])])):S("",!0)]),_:1}),n(U,{label:"Activity",name:"activity"},{default:l(()=>[L((D(),v(M,{stripe:"",style:{width:"100%"},size:"large",data:e.activityDatas.tableData,"element-loading-background":"rgba(0, 0, 0, 0.4)","empty-text":e.activityDatas.loadState==2?"Empty":" "},{default:l(()=>[n(m,{label:"Amount",width:"150"},{default:l(a=>[c("div",At,u(a.row.amount),1)]),_:1}),n(m,{label:"Price",width:"120"},{default:l(a=>[n(x,{class:"contentCol"},{default:l(()=>[xt,d(" "+u(a.row.price/1000000n),1)]),_:2},1024)]),_:1}),n(m,{label:"Price unit",width:"250"},{default:l(a=>[c("div",wt,[d(u(a.row.priceUnitStr)+" ",1),a.row.bPriceUnitSup?(D(),_("label",Tt,[d(" x 10"),Bt])):S("",!0),c("span",null," STX/"+u(e.activityDatas.curWrapperToken),1)])]),_:1}),n(m,{label:"Seller",width:"150px"},{default:l(a=>[c("a",{href:"https://explorer.hiro.so/address/"+a.row.seller+"?chain="+r._inGetNetType(),target:"_blank"},u(a.row.briefSeller),9,Vt)]),_:1}),n(m,{label:"Buyer",width:"150px"},{default:l(a=>[c("a",{href:"https://explorer.hiro.so/address/"+a.row.buyer+"?chain="+r._inGetNetType(),target:"_blank"},u(a.row.briefBuyer),9,It)]),_:1}),n(m,{label:"Time"},{default:l(a=>[c("div",Nt,u(a.row.timeStr),1)]),_:1})]),_:1},8,["data","empty-text"])),[[z,e.activityDatas.loadState==1]]),e.activityDatas.totalCount>e.activityDatas.kPageSize?(D(),_("div",Ut,[n(E,{disabled:e.activityDatas.loadState!=2,layout:"total, prev, pager, next, jumper","default-page-size":e.activityDatas.kPageSize,"current-page":e.activityDatas.curPage,"onUpdate:currentPage":t[5]||(t[5]=a=>e.activityDatas.curPage=a),total:e.activityDatas.totalCount,onCurrentChange:t[6]||(t[6]=a=>r.loadActivityPage(e.activityDatas.curPage))},null,8,["disabled","default-page-size","current-page","total"])])):S("",!0)]),_:1})]),_:1},8,["modelValue","onTabChange"])):S("",!0),e.bSignedIn?S("",!0):(D(),v(b,{key:1,type:"primary",size:"large",onClick:r.onClickSignIn},{default:l(()=>[d("Sign in to view")]),_:1},8,["onClick"])),n(q,{center:!0,title:e.listDialogData.title,modelValue:e.listDialogData.bVisible,"onUpdate:modelValue":t[10]||(t[10]=a=>e.listDialogData.bVisible=a),width:"500px"},{default:l(()=>[n(F,{class:"fcenter",ref:"form",model:e.listDialogData,"label-width":"100"},{default:l(()=>[n(k,null,{label:l(()=>[zt]),default:l(()=>[n(w,{modelValue:e.listDialogData.amountStr,"onUpdate:modelValue":t[8]||(t[8]=a=>e.listDialogData.amountStr=a),clearable:"",size:"large",placeholder:"Integer count"},{append:l(()=>[n(b,{type:"primary",onClick:r.onClickListMax},{default:l(()=>[d("Max")]),_:1},8,["onClick"])]),_:1},8,["modelValue"])]),_:1}),n(k,null,{label:l(()=>[Lt]),default:l(()=>[n(w,{modelValue:e.listDialogData.priceStr,"onUpdate:modelValue":t[9]||(t[9]=a=>e.listDialogData.priceStr=a),clearable:"",size:"large",placeholder:"Integer count"},{append:l(()=>[d(" STX ")]),_:1},8,["modelValue"])]),_:1}),n(k,null,{default:l(()=>[n(b,{type:"primary",onClick:r.onClickDialogList,disabled:!r.listBtnEnabled},{default:l(()=>[d(u(e.listDialogData.title),1)]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title","modelValue"]),n(q,{center:!0,title:"Change price",modelValue:e.changePriceDialogData.bVisible,"onUpdate:modelValue":t[13]||(t[13]=a=>e.changePriceDialogData.bVisible=a),width:"500px"},{default:l(()=>[n(F,{class:"fcenter",ref:"form",model:e.changePriceDialogData,"label-width":"100"},{default:l(()=>[n(k,null,{label:l(()=>[Wt]),default:l(()=>[n(w,{modelValue:e.changePriceDialogData.amountStr,"onUpdate:modelValue":t[11]||(t[11]=a=>e.changePriceDialogData.amountStr=a),clearable:"",disabled:"",size:"large",placeholder:"Integer count"},null,8,["modelValue"])]),_:1}),n(k,null,{label:l(()=>[Mt]),default:l(()=>[n(w,{modelValue:e.changePriceDialogData.priceStr,"onUpdate:modelValue":t[12]||(t[12]=a=>e.changePriceDialogData.priceStr=a),clearable:"",size:"large",placeholder:"Integer count"},{append:l(()=>[d(" STX ")]),_:1},8,["modelValue"])]),_:1}),n(k,null,{default:l(()=>[n(b,{type:"primary",onClick:r.onClickDialogChangePrice,disabled:!r.changePriceBtnEnabled},{default:l(()=>[d("Change price")]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}const jt=K(ut,[["render",Et],["__scopeId","data-v-507499ac"]]);export{jt as default};
