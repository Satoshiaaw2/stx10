import{_ as H,u as Y,a as J,g as k,l as K,v as x,x as C,y as Q,z as R,A as L,b as Z,B as $,r as h,c as tt,o as g,d as f,e as o,w as n,m as T,j as D,f as s,t as c,h as u,k as A,C as E,p as et,q as at,s as W,D as it,n as nt}from"./index-7759e4cb.js";import{U as b,a as I,m as ot,C as U}from"./ContractHelper-0462d477.js";import{S as rt,s as q}from"./supabase-7b036e18.js";const F=it(),v=nt(),lt={name:"MinePage",components:{SelectTokenDialog:rt},computed:{listBtnEnabled(){this.listDialogData.amountStr=this.listDialogData.amountStr.trim();const i=this.listDialogData.amountStr;if(!/^[0-9]{1,16}$/i.test(i))return!1;const t=BigInt(i);if(t<=0n)return!1;if(this.listDialogData.listType==1){if(t>this.balanceData.stx10Balance)return!1}else if(this.listDialogData.listType==2){if(t*BigInt(Math.pow(10,this.tokenStore.curTokenData.decimal))>this.balanceData.sip10Balance)return!1}else return!1;this.listDialogData.priceStr=this.listDialogData.priceStr.trim();const r=this.listDialogData.priceStr;if(!/^[0-9]{1,7}$/i.test(r))return!1;const d=BigInt(r)*1000000n;return!(d<1000000n||d>1000000000000n||d/t>1000000000n)},changePriceBtnEnabled(){const i=this.changePriceDialogData.priceStr.trim();if(this.changePriceDialogData.priceStr=i,i==this.changePriceDialogData.originPriceStr||!/^[0-9]{1,7}$/i.test(i))return!1;const t=BigInt(i)*1000000n;return!(t<1000000n||t>1000000000000n||t/BigInt(this.changePriceDialogData.amountStr)>1000000000n)}},data(){return{tokenStore:Y(),utils:b,bSignedIn:J.isUserSignedIn(),activeTabName:"balance",balanceData:{loadState:0,stx10Balance:0n,sip10Balance:0n,sip10BalanceStr:""},ordersData:{kPageSize:25,totalCount:-1,curPage:1,loadState:0,tableData:[]},activityDatas:{kPageSize:25,totalCount:-1,curPage:1,loadState:0,tableData:[]},listDialogData:{bVisible:!1,listType:0,title:"--",amountStr:"",priceStr:""},changePriceDialogData:{bVisible:!1,state:0,originPriceStr:"",orderInfo:null,amountStr:"",priceStr:""},refreshTip:"Please refresh page."}},async mounted(){this.tokenStore.setCurVuePage(this),this.bSignedIn&&this.loadBalance()},methods:{onClickChangeToken(){this.$refs.searchTokenDialog.show()},onChangeToken(){this.bSignedIn&&(this.activeTabName=="balance"?this.loadBalance():this.activeTabName=="orders"?this.loadOrdersPage(1):this.activeTabName=="activity"&&this.loadActivityPage(1))},async loadBalance(){this.balanceData.loadState=1;const i=this.tokenStore.curTokenName,t=await I.queryTokenBalances(this.tokenStore.curTokenData,k());if(i!=this.tokenStore.curTokenName)return;const r=this.tokenStore.getTokenData(i);this.balanceData.loadState=2,this.balanceData.stx10Balance=t.stx10Balance,this.balanceData.sip10Balance=t.sip10Balance,this.balanceData.sip10BalanceStr=(t.sip10Balance/BigInt(Math.pow(10,r.decimal))).toString()},onClickSignIn(){K()},async onClickWrapAndList(){this.listDialogData.bVisible=!0,this.listDialogData.listType=1,this.listDialogData.title="Wrap and list",this.listDialogData.priceStr="",this.setAmountMax()},async onClickList(){this.listDialogData.bVisible=!0,this.listDialogData.listType=2,this.listDialogData.title="List",this.listDialogData.priceStr="",this.setAmountMax()},onClickListMax(){this.setAmountMax()},setAmountMax(){this.listDialogData.listType==1?this.listDialogData.amountStr=this.balanceData.stx10Balance.toString():this.listDialogData.listType==2&&(this.listDialogData.amountStr=(this.balanceData.sip10Balance/BigInt(Math.pow(10,this.tokenStore.curTokenData.decimal))).toString())},onClickDialogList(){let i=null,t=null;const r=this.tokenStore.curTokenData;if(this.listDialogData.listType==1)i="wrap_and_create_order",t=[x(r.contractAddress,r.contractName),C(this.listDialogData.amountStr),C(BigInt(this.listDialogData.priceStr)*1000000n)];else if(this.listDialogData.listType==2)i="create_order",t=[C(1),x(r.contractAddress,r.contractName),C(this.listDialogData.amountStr),C(BigInt(this.listDialogData.priceStr)*1000000n)];else return;const d=Q(r.contractAddress,r.contractName,r.tokenName);let e=[];e.push(ot(k(),R.Equal,BigInt(this.listDialogData.amountStr)*BigInt(Math.pow(10,r.decimal)),d));const l={contractAddress:v.defaultContractAddress,contractName:v.marketContract.name,functionName:i,functionArgs:t,network:F,appDetails:E(),postConditions:e,onFinish:p=>{this.listDialogData.bVisible=!1,U.tipTxid(p.txId,"List transaction has been sent.")}};L(l)},async loadOrdersPage(i){this.ordersData.curPage=i,this.ordersData.loadState=1;const t=(i-1)*this.ordersData.kPageSize,r=t+this.ordersData.kPageSize-1,d=i,{data:e,error:l,status:p,count:_}=await q.from("orders").select("*",{count:"exact"}).eq("token",this.tokenStore.curTokenName).eq("state",1).eq("offer",k()).order("block",{ascending:!1}).range(t,r);this.ordersData.loadState=2,d==this.ordersData.curPage&&(l?(console.log("loadOrdersPage error: ",{error:l,status:p,data:e,count:_}),b.alert("load page error")):(this.ordersData.totalCount=_,this.setOrdersTableData(e)))},async setOrdersTableData(i){this.ordersData.tableData.splice(0,this.ordersData.tableData.length);for(const t of i){const r=b.formatPriceUnit(BigInt(t.priceunit),this.tokenStore.stxPrice);this.ordersData.tableData.push({orderMode:t.mode,orderId:t.orderid,state:t.state,block:t.block,tokenName:t.token,offer:t.offer,amount:BigInt(t.amount),price:BigInt(t.price),priceunit:t.priceunit,priceUnitStr:r.priceUnitStr,priceUnitSub:r.sub,bPending:!1})}},async onClickChangePrice(i){let t=this.changePriceDialogData;t.bVisible=!0,t.orderInfo=i,t.amountStr=i.amount.toString(),t.priceStr=t.originPriceStr=(i.price/1000000n).toString(),t.state=0},async onClickDialogChangePrice(){const i=this.changePriceDialogData.orderInfo;if(this.changePriceDialogData.priceStr==(i.price/1000000n).toString())return;const t=BigInt(this.changePriceDialogData.priceStr)*1000000n;if(i.orderMode==2&&t>i.price){this.changePriceDialogData.state=1;let d=await U.getAccountBalance(k());if(this.changePriceDialogData.state=2,d<=t){b.alert("Balance unenough!");return}d<=t+2000000n&&b.alert(`Make sure transaction fee less than ${(d-t)/1000000n} STX!`)}let r=this;I.changePrice(i,t,function(){r.changePriceDialogData.bVisible=!1})},async onClickCancel(i){let t=this;this.$confirm(`Are you sure to cancel ${i.mode==1?"list":"bid"}?`,"Attention",{confirmButtonText:"Yes",cancelButtonText:"Cancel",type:"warning"}).then(()=>{t.sureCancelOrder(i)})},async sureCancelOrder(i){I.cancelOrder(i)},async loadActivityPage(i){this.activityDatas.curPage=i,this.activityDatas.loadState=1;const t=(i-1)*this.activityDatas.kPageSize,r=t+this.activityDatas.kPageSize-1,d=i,{data:e,error:l,status:p,count:_}=await q.from("trade").select("*",{count:"exact"}).eq("token",this.tokenStore.curTokenName).or(`offer.eq.${k()},taker.eq.${k()}`).order("block",{ascending:!1}).range(t,r);this.activityDatas.loadState=2,d==this.activityDatas.curPage&&(l?(console.log("loadActivityPage error: ",{error:l,status:p,data:e,count:_}),b.alert("load page error")):(this.activityDatas.totalCount=_,this.setActivityTableData(e)))},async setActivityTableData(i){this.activityDatas.tableData.splice(0,this.activityDatas.tableData.length);const t=k();for(const r of i){const d=b.formatPriceUnit(BigInt(r.priceunit),this.tokenStore.stxPrice);this.activityDatas.tableData.push({orderId:r.orderid,orderMode:r.mode,timeStr:b.formatTime(r.stamp),tokenName:r.token,offer:r.offer,briefOffer:t==r.offer?"Me":b.getBriefAddress(r.offer),amount:BigInt(r.amount),price:BigInt(r.price),priceunit:r.priceunit,priceUnitStr:d.priceUnitStr,priceUnitSub:d.sub,taker:r.taker,briefTaker:t==r.taker?"Me":b.getBriefAddress(r.taker)})}},onChangeTab(){this.bSignedIn&&(this.activeTabName=="balance"?this.loadBalance():this.activeTabName=="orders"?this.loadOrdersPage(1):this.activeTabName=="activity"&&this.loadActivityPage(1))},async updatePriceUnitData(){for(let i of this.ordersData.tableData){const t=b.formatPriceUnit(BigInt(i.priceunit),this.tokenStore.stxPrice);i.priceUnitStr=t.priceUnitStr,i.priceUnitSub=t.sub}for(let i of this.activityDatas.tableData){const t=b.formatPriceUnit(BigInt(i.priceunit),this.tokenStore.stxPrice);i.priceUnitStr=t.priceUnitStr,i.priceUnitSub=t.sub}},_inGetNetType(){return Z()},onClickAddPair(){let i="set_valid_token";const t=[x(this.tokenStore.curTokenData.contractAddress,this.tokenStore.curTokenData.contractName),$()];let r=[];const d={contractAddress:v.defaultContractAddress,contractName:v.marketContract.name,functionName:i,functionArgs:t,network:F,appDetails:E(),postConditions:r,onFinish:e=>{U.tipTxid(e.txId,"Add tick wrapper pair transaction has been sent.")}};L(d)}}},S=i=>(et("data-v-de80f023"),i=i(),at(),i),st={id:"main"},ct=S(()=>s("span",{style:{color:"#ccc"}},"Token:",-1)),dt=["src"],ut={key:0,direction:"vertical",id:"balanceValueArea"},gt={class:"tokenName"},pt={class:"tokenAmount"},ht=["src"],Dt={class:"tokenAmount"},mt={key:1,"element-loading-background":"rgba(0, 0, 0, 0)",style:{"text-align":"left","margin-top":"32px",height:"80px",width:"100px"}},ft={class:"contentCol"},bt={class:"contentCol"},_t=S(()=>s("img",{src:W,width:"20",height:"20"},null,-1)),kt={class:"contentCol"},St={key:0},yt={key:1},Ct={key:2},Pt={key:0,class:"pagiArea"},Tt={class:"contentCol"},vt={class:"contentCol"},wt=S(()=>s("img",{src:W,width:"20",height:"20"},null,-1)),Bt={class:"contentCol"},xt={key:0},At={key:1},It={key:2},Ut=["href"],Vt=["href"],Nt={class:"contentCol"},Mt={key:0,class:"pagiArea"},zt={key:1,style:{"margin-top":"32px"}},Ot=S(()=>s("span",{class:"wrapperTip"},"Amount:",-1)),Lt=S(()=>s("span",{class:"wrapperTip"},"Price:",-1)),Et=S(()=>s("span",{class:"wrapperTip"},"Amount:",-1)),qt=S(()=>s("span",{class:"wrapperTip"},"Price:",-1));function Ft(i,t,r,d,e,l){const p=h("el-button"),_=h("el-space"),V=h("el-card"),w=h("el-tab-pane"),m=h("el-table-column"),N=h("el-table"),M=h("el-pagination"),j=h("el-tabs"),G=h("SelectTokenDialog"),P=h("el-input"),y=h("el-form-item"),z=h("el-form"),O=h("el-dialog"),B=tt("loading");return g(),f("div",st,[o(_,{alignment:"center",style:{"text-align":"center"}},{default:n(()=>[ct,s("img",{src:e.tokenStore.curTokenIconSrc,width:"32",height:"32",class:"tokenIcon"},null,8,dt),s("span",null,c(e.tokenStore.curTokenName),1),o(p,{style:{"margin-left":"8px"},type:"primary",onClick:l.onClickChangeToken},{default:n(()=>[u("Change")]),_:1},8,["onClick"])]),_:1}),e.bSignedIn?(g(),T(j,{key:0,modelValue:e.activeTabName,"onUpdate:modelValue":t[6]||(t[6]=a=>e.activeTabName=a),size:"large",style:{"margin-top":"32px","text-align":"left"},onTabChange:l.onChangeTab},{default:n(()=>[o(w,{label:"Balance",name:"balance"},{default:n(()=>[e.balanceData.loadState==2?(g(),f("div",ut,[e.tokenStore.curTokenData.stx10Name?(g(),T(V,{key:0,shadow:"hover",class:"cardArea","body-style":{padding:"8px"}},{default:n(()=>[s("div",gt,c(e.tokenStore.curTokenData.stx10Name),1),s("div",pt,c(e.balanceData.stx10Balance),1),o(p,{class:"tokenBtn",type:"primary",disabled:e.balanceData.stx10Balance==0n,onClick:t[0]||(t[0]=a=>l.onClickWrapAndList())},{default:n(()=>[u("Wrap and list")]),_:1},8,["disabled"])]),_:1})):D("",!0),o(V,{shadow:"hover",class:"cardArea","body-style":{padding:"8px"}},{default:n(()=>[o(_,{class:"tokenName"},{default:n(()=>[s("img",{src:e.tokenStore.curTokenIconSrc,width:"32",height:"32",class:"tokenIcon"},null,8,ht),s("div",null,c(e.tokenStore.curTokenData.tokenName),1)]),_:1}),s("div",Dt,c(e.balanceData.sip10BalanceStr),1),o(p,{class:"tokenBtn",type:"primary",disabled:e.balanceData.sip10Balance==0n,onClick:t[1]||(t[1]=a=>l.onClickList())},{default:n(()=>[u("List")]),_:1},8,["disabled"])]),_:1})])):D("",!0),e.balanceData.loadState==1?A((g(),f("div",mt,null,512)),[[B,!0]]):D("",!0)]),_:1}),o(w,{label:"Orders",name:"orders"},{default:n(()=>[A((g(),T(N,{stripe:"",style:{width:"100%"},size:"large",data:e.ordersData.tableData,"element-loading-background":"rgba(0, 0, 0, 0.4)","empty-text":e.ordersData.loadState==2?"Empty":" "},{default:n(()=>[o(m,{label:"Mode",width:"110"},{default:n(a=>[s("div",ft,c(a.row.orderMode==1?"Buy":"Bid"),1)]),_:1}),o(m,{label:"Amount",width:"150"},{default:n(a=>[s("div",bt,c(e.utils.formatAmount(a.row.amount)),1)]),_:1}),o(m,{label:"Price",width:"150"},{default:n(a=>[o(_,{class:"contentCol"},{default:n(()=>[_t,u(" "+c(a.row.price/1000000n),1)]),_:2},1024)]),_:1}),o(m,{label:"Price unit",width:"150"},{default:n(a=>[s("div",kt,[a.row.priceUnitStr!="-"?(g(),f("span",St,"$")):D("",!0),a.row.priceUnitSub?(g(),f("span",yt,[u("0.0"),s("sub",null,c(a.row.priceUnitSub),1),u(c(a.row.priceUnitStr),1)])):D("",!0),a.row.priceUnitSub?D("",!0):(g(),f("span",Ct,c(a.row.priceUnitStr),1))])]),_:1}),o(m,{label:"Action"},{default:n(a=>[o(p,{plain:"",onClick:X=>l.onClickChangePrice(a.row)},{default:n(()=>[u("Change price")]),_:2},1032,["onClick"]),o(p,{plain:"",onClick:X=>l.onClickCancel(a.row)},{default:n(()=>[u("Cancel "+c(a.row.orderMode==1?"list":"bid"),1)]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data","empty-text"])),[[B,e.ordersData.loadState==1]]),e.ordersData.totalCount>e.ordersData.kPageSize?(g(),f("div",Pt,[o(M,{disabled:e.ordersData.loadState!=2,layout:"total, prev, pager, next, jumper","default-page-size":e.ordersData.kPageSize,"current-page":e.ordersData.curPage,"onUpdate:currentPage":t[2]||(t[2]=a=>e.ordersData.curPage=a),total:e.ordersData.totalCount,onCurrentChange:t[3]||(t[3]=a=>l.loadOrdersPage(e.ordersData.curPage))},null,8,["disabled","default-page-size","current-page","total"])])):D("",!0)]),_:1}),o(w,{label:"Trades",name:"activity"},{default:n(()=>[A((g(),T(N,{stripe:"",style:{width:"100%"},size:"large",data:e.activityDatas.tableData,"element-loading-background":"rgba(0, 0, 0, 0.4)","empty-text":e.activityDatas.loadState==2?"Empty":" "},{default:n(()=>[o(m,{label:"Mode",width:"110"},{default:n(a=>[s("div",Tt,c(a.row.orderMode==1?"Buy":"Accept bid"),1)]),_:1}),o(m,{label:"Amount",width:"150"},{default:n(a=>[s("div",vt,c(e.utils.formatAmount(a.row.amount)),1)]),_:1}),o(m,{label:"Price",width:"150"},{default:n(a=>[o(_,{class:"contentCol"},{default:n(()=>[wt,u(" "+c(a.row.price/1000000n),1)]),_:2},1024)]),_:1}),o(m,{label:"Price unit",width:"150"},{default:n(a=>[s("div",Bt,[a.row.priceUnitStr!="-"?(g(),f("span",xt,"$")):D("",!0),a.row.priceUnitSub?(g(),f("span",At,[u("0.0"),s("sub",null,c(a.row.priceUnitSub),1),u(c(a.row.priceUnitStr),1)])):D("",!0),a.row.priceUnitSub?D("",!0):(g(),f("span",It,c(a.row.priceUnitStr),1))])]),_:1}),o(m,{label:"Offer",width:"180px"},{default:n(a=>[s("a",{href:"https://explorer.hiro.so/address/"+a.row.offer+"?chain="+l._inGetNetType(),target:"_blank",class:"ahref"},c(a.row.briefOffer),9,Ut),u(" ("+c(a.row.orderMode==1?"seller":"buyer")+") ",1)]),_:1}),o(m,{label:"Taker",width:"180px"},{default:n(a=>[s("a",{href:"https://explorer.hiro.so/address/"+a.row.taker+"?chain="+l._inGetNetType(),target:"_blank",class:"ahref"},c(a.row.briefTaker),9,Vt),u(" ("+c(a.row.orderMode==2?"seller":"buyer")+") ",1)]),_:1}),o(m,{label:"Time"},{default:n(a=>[s("div",Nt,c(a.row.timeStr),1)]),_:1})]),_:1},8,["data","empty-text"])),[[B,e.activityDatas.loadState==1]]),e.activityDatas.totalCount>e.activityDatas.kPageSize?(g(),f("div",Mt,[o(M,{disabled:e.activityDatas.loadState!=2,layout:"total, prev, pager, next, jumper","default-page-size":e.activityDatas.kPageSize,"current-page":e.activityDatas.curPage,"onUpdate:currentPage":t[4]||(t[4]=a=>e.activityDatas.curPage=a),total:e.activityDatas.totalCount,onCurrentChange:t[5]||(t[5]=a=>l.loadActivityPage(e.activityDatas.curPage))},null,8,["disabled","default-page-size","current-page","total"])])):D("",!0)]),_:1})]),_:1},8,["modelValue","onTabChange"])):D("",!0),e.bSignedIn?D("",!0):(g(),f("div",zt,[o(p,{type:"primary",size:"large",onClick:l.onClickSignIn},{default:n(()=>[u("Sign in to view")]),_:1},8,["onClick"])])),o(G,{ref:"searchTokenDialog",onOnChangeToken:l.onChangeToken},null,8,["onOnChangeToken"]),o(O,{center:!0,title:e.listDialogData.title,modelValue:e.listDialogData.bVisible,"onUpdate:modelValue":t[9]||(t[9]=a=>e.listDialogData.bVisible=a),width:"500px"},{default:n(()=>[o(z,{class:"fcenter",ref:"form",model:e.listDialogData,"label-width":"100"},{default:n(()=>[o(y,null,{label:n(()=>[Ot]),default:n(()=>[o(P,{modelValue:e.listDialogData.amountStr,"onUpdate:modelValue":t[7]||(t[7]=a=>e.listDialogData.amountStr=a),clearable:"",size:"large",placeholder:"Integer count"},{append:n(()=>[o(p,{type:"primary",onClick:l.onClickListMax},{default:n(()=>[u("Max")]),_:1},8,["onClick"])]),_:1},8,["modelValue"])]),_:1}),o(y,null,{label:n(()=>[Lt]),default:n(()=>[o(P,{modelValue:e.listDialogData.priceStr,"onUpdate:modelValue":t[8]||(t[8]=a=>e.listDialogData.priceStr=a),clearable:"",size:"large",placeholder:"Integer count"},{append:n(()=>[u(" STX ")]),_:1},8,["modelValue"])]),_:1}),o(y,null,{default:n(()=>[o(p,{type:"primary",onClick:l.onClickDialogList,disabled:!l.listBtnEnabled},{default:n(()=>[u(c(e.listDialogData.title),1)]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title","modelValue"]),o(O,{center:!0,title:"Change price",modelValue:e.changePriceDialogData.bVisible,"onUpdate:modelValue":t[12]||(t[12]=a=>e.changePriceDialogData.bVisible=a),width:"500px"},{default:n(()=>[o(z,{class:"fcenter",ref:"form",model:e.changePriceDialogData,"label-width":"100"},{default:n(()=>[o(y,null,{label:n(()=>[Et]),default:n(()=>[o(P,{modelValue:e.changePriceDialogData.amountStr,"onUpdate:modelValue":t[10]||(t[10]=a=>e.changePriceDialogData.amountStr=a),clearable:"",disabled:"",size:"large",placeholder:"Integer count"},null,8,["modelValue"])]),_:1}),o(y,null,{label:n(()=>[qt]),default:n(()=>[o(P,{modelValue:e.changePriceDialogData.priceStr,"onUpdate:modelValue":t[11]||(t[11]=a=>e.changePriceDialogData.priceStr=a),clearable:"",size:"large",placeholder:"Integer count"},{append:n(()=>[u(" STX ")]),_:1},8,["modelValue"])]),_:1}),o(y,null,{default:n(()=>[o(p,{type:"primary",loading:e.changePriceDialogData.state==1,onClick:l.onClickDialogChangePrice,disabled:!l.changePriceBtnEnabled},{default:n(()=>[u("Change price")]),_:1},8,["loading","onClick","disabled"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}const Xt=H(lt,[["render",Ft],["__scopeId","data-v-de80f023"]]);export{Xt as default};
