import{_ as K,u as O,a as P,l as Q,c as T,b as f,d as X,F as j,e as B,g as R,B as Z,r as p,f as $,o as D,h as _,s as v,w as l,p as S,i as n,j as tt,k as et,m as at,t as c,v as u,q as d,n as L,x as V,y as it,z as lt,C as nt,A as st}from"./index-87936d70.js";import{C as rt,c as ot,U as x,b as ct}from"./ContractHelper-bc54eede.js";import{s as G,C as I,_ as H}from"./stx-icon-45e3c94e.js";const N=st(),g=tt(),ut={name:"MinePage",components:{},computed:{listBtnEnabled(){this.listDialogData.amountStr=this.listDialogData.amountStr.trim();const i=this.listDialogData.amountStr;if(!/^[0-9]{1,16}$/i.test(i))return!1;const e=BigInt(i);if(e<=0n)return!1;if(this.listDialogData.listType==1){if(e>this.balanceData.stx10Balance)return!1}else if(this.listDialogData.listType==2){if(e*1000000n>this.balanceData.sip10Balance)return!1}else return!1;this.listDialogData.priceStr=this.listDialogData.priceStr.trim();const s=this.listDialogData.priceStr;if(!/^[0-9]{1,16}$/i.test(s))return!1;const o=BigInt(s);return!(o<1n||o>1000000n||o/e>1000n)},changePriceBtnEnabled(){this.changePriceDialogData.priceStr=this.changePriceDialogData.priceStr.trim();const i=this.changePriceDialogData.priceStr;if(!/^[0-9]{1,16}$/i.test(i))return!1;const e=BigInt(i);return!(e<1n||e>1000000n||e/BigInt(this.changePriceDialogData.amountStr)>1000n)}},data(){return{bSignedIn:O.isUserSignedIn(),activeTabName:"balance",sip10NameList:["Wsbtc"],balanceData:{curStx10Name:"sbtc",curSip10Name:"Wsbtc",loadState:0,stx10Balance:0n,sip10Balance:0n},listingData:{curWrapperToken:"Wsbtc",kPageSize:25,totalCount:-1,curPage:1,loadState:0,tableData:[]},activityDatas:{curWrapperToken:"Wsbtc",kPageSize:25,totalCount:-1,curPage:1,loadState:0,tableData:[]},listDialogData:{bVisible:!1,listType:0,title:"--",amountStr:"",priceStr:""},changePriceDialogData:{bVisible:!1,orderInfo:null,amountStr:"",priceStr:""}}},async mounted(){this.bSignedIn&&this.loadBalance()},methods:{async loadBalance(){this.balanceData.loadState=1;const i=await rt.queryWrapSummary(this.balanceData.curStx10Name,P());this.balanceData.loadState=2,this.balanceData.stx10Balance=i.stx10Balance,this.balanceData.sip10Balance=i.sip10Balance},onClickSignIn(){Q()},async onClickWrapAndList(){this.listDialogData.bVisible=!0,this.listDialogData.listType=1,this.listDialogData.title="Wrap and list",this.listDialogData.priceStr="",this.setAmountMax()},async onClickList(){this.listDialogData.bVisible=!0,this.listDialogData.listType=2,this.listDialogData.title="List",this.listDialogData.priceStr="",this.setAmountMax()},onClickListMax(){this.setAmountMax()},setAmountMax(){this.listDialogData.listType==1?this.listDialogData.amountStr=this.balanceData.stx10Balance.toString():this.listDialogData.listType==2&&(this.listDialogData.amountStr=(this.balanceData.sip10Balance/1000000n).toString())},onClickDialogList(){let i=null;const e=[T(g.defaultWrapperContractAddress,this.balanceData.curSip10Name),f(this.listDialogData.amountStr),f(BigInt(this.listDialogData.priceStr)*1000000n)];if(this.listDialogData.listType==1)i="wrap_and_list_token";else if(this.listDialogData.listType==2)i="list_token";else return;const s=X(g.defaultWrapperContractAddress,this.balanceData.curSip10Name,this.balanceData.curSip10Name);let o=[];o.push(ot(P(),j.Equal,BigInt(BigInt(this.listDialogData.amountStr)*1000000n),s));const t={contractAddress:g.defaultContractAddress,contractName:g.marketContract.name,functionName:i,functionArgs:e,network:N,appDetails:V(),postConditions:o,onFinish:r=>{this.listDialogData.bVisible=!1,I.tipTxid(r.txId,"List transaction has been sent.")}};B(t)},async loadListingPage(i){this.listingData.curPage=i,this.listingData.loadState=1;const e=(i-1)*this.listingData.kPageSize,s=e+this.listingData.kPageSize-1,o=i,{data:t,error:r,status:y,count:C}=await G.from("listings").select("*",{count:"exact"}).eq("state",1).eq("seller",P()).order("block",{ascending:!1}).range(e,s);this.listingData.loadState=2,o==this.listingData.curPage&&(r?(console.log("loadListingPage error: ",{error:r,status:y,data:t,count:C}),x.alert("load page error")):(this.listingData.totalCount=C,this.setListingTableData(t)))},async setListingTableData(i){this.listingData.tableData.splice(0,this.listingData.tableData.length);for(const e of i){const[s,o]=this.calcPriceUnit(BigInt(e.priceunit));this.listingData.tableData.push({orderId:e.orderid,state:e.state,block:e.block,wrapperTokenName:e.wrapper,seller:e.seller,amount:BigInt(e.amount),price:BigInt(e.price),priceUnitStr:s,bPriceUnitSup:o,bPending:!1})}},async onClickChangePrice(i){this.changePriceDialogData.bVisible=!0,this.changePriceDialogData.orderInfo=i,this.changePriceDialogData.amountStr=i.amount.toString(),this.changePriceDialogData.priceStr=(i.price/1000000n).toString()},async onClickDialogChangePrice(){const i=this.changePriceDialogData.orderInfo;if(this.changePriceDialogData.priceStr==(i.price/1000000n).toString())return;let e="change_price";const s=[f(i.orderId),T(g.defaultWrapperContractAddress,this.balanceData.curSip10Name),f(i.amount),f(BigInt(this.changePriceDialogData.priceStr)*1000000n)];let o=[];const t={contractAddress:g.defaultContractAddress,contractName:g.marketContract.name,functionName:e,functionArgs:s,network:N,appDetails:V(),postConditions:o,onFinish:r=>{this.changePriceDialogData.bVisible=!1,I.tipTxid(r.txId,"Change price transaction has been sent.")}};B(t)},async onClickCancel(i){let e=this;this.$confirm("Are you sure to cancel list it?","Attention",{confirmButtonText:"Yes",cancelButtonText:"Cancel",type:"warning"}).then(()=>{e.sureCancelList(i)})},async sureCancelList(i){let e="cancel_list";const s=[f(i.orderId),T(g.defaultWrapperContractAddress,this.listingData.curWrapperToken),f(i.amount),f(i.price)];let o=[];const t=X(g.defaultWrapperContractAddress,this.listingData.curWrapperToken,this.listingData.curWrapperToken);o.push(ct(g.defaultContractAddress,g.marketContract.name,j.Equal,BigInt(i.amount*1000000n),t));const r={contractAddress:g.defaultContractAddress,contractName:g.marketContract.name,functionName:e,functionArgs:s,network:N,appDetails:V(),postConditions:o,onFinish:y=>{this.changePriceDialogData.bVisible=!1,I.tipTxid(y.txId,"Cancel list transaction has been sent.")}};B(r)},async loadActivityPage(i){this.activityDatas.curPage=i,this.activityDatas.loadState=1;const e=(i-1)*this.activityDatas.kPageSize,s=e+this.activityDatas.kPageSize-1,o=i,{data:t,error:r,status:y,count:C}=await G.from("activity").select("*",{count:"exact"}).or(`seller.eq.${P()},buyer.eq.${P()}`).order("block",{ascending:!1}).range(e,s);this.activityDatas.loadState=2,o==this.activityDatas.curPage&&(r?(console.log("loadActivityPage error: ",{error:r,status:y,data:t,count:C}),x.alert("load page error")):(this.activityDatas.totalCount=C,this.setActivityTableData(t)))},async setActivityTableData(i){this.activityDatas.tableData.splice(0,this.activityDatas.tableData.length);const e=P();for(const s of i){const[o,t]=this.calcPriceUnit(BigInt(s.priceunit));this.activityDatas.tableData.push({orderId:s.orderid,timeStr:x.formatTime(s.stamp),wrapperTokenName:s.wrapper,seller:s.seller,briefSeller:e==s.seller?"Me":x.getBriefAddress(s.seller),amount:BigInt(s.amount),price:BigInt(s.price),priceUnitStr:o,bPriceUnitSup:t,buyer:s.buyer,briefBuyer:e==s.buyer?"Me":x.getBriefAddress(s.buyer)})}},calcPriceUnit(i){const e=i.toString();let[s,o]=[!1,null];if(e.length<=14)14-e.length<6?s="0."+"0".repeat(14-e.length)+e.substr(0,3).replace(/(0+)$/g,""):(o=!0,s="0."+"0".repeat(8-e.length)+e.substr(0,3).replace(/(0+)$/g,""));else{s=e.substring(0,e.length-14);let t=e.substring(e.length-14).replace(/(0+)$/g,"");t.length>0&&(t=t.substr(0,4).replace(/(0+)$/g,""),t!=""?s=s+"."+t:s=s+".0001")}return[s,o]},onChangeTab(){this.bSignedIn&&(this.activeTabName=="balance"?this.loadBalance():this.activeTabName=="listing"?this.loadListingPage(1):this.activeTabName=="activity"&&this.loadActivityPage(1))},_inGetNetType(){return R()},onClickAddPair(){let i="add_tick_wrapper_pair";const e=[Z("sbtc"),T(g.defaultWrapperContractAddress,this.balanceData.curSip10Name)];let s=[];const o={contractAddress:g.defaultContractAddress,contractName:g.marketContract.name,functionName:i,functionArgs:e,network:N,appDetails:V(),postConditions:s,onFinish:t=>{I.tipTxid(t.txId,"Add tick wrapper pair transaction has been sent.")}};B(o)}}},h=i=>(it("data-v-ab27836b"),i=i(),lt(),i),dt={id:"main"},gt=h(()=>c("span",{id:"selTip"},"Select token:",-1)),pt=h(()=>c("p",null,null,-1)),Dt={key:0,direction:"vertical",id:"balanceValueArea"},ht={class:"tokenName"},mt={class:"tokenAmount"},bt=h(()=>c("img",{src:nt,width:"20",height:"20"},null,-1)),ft={class:"tokenAmount"},_t={key:1,"element-loading-background":"rgba(0, 0, 0, 0)",style:{"text-align":"left","margin-top":"32px",height:"80px",width:"100px"}},St={class:"contentCol"},yt=h(()=>c("img",{src:H,width:"20",height:"20"},null,-1)),Ct={class:"contentCol"},kt={key:0},Pt=h(()=>c("sup",null,"-6",-1)),vt={key:0,class:"pagiArea"},xt={class:"contentCol"},At=h(()=>c("img",{src:H,width:"20",height:"20"},null,-1)),wt={class:"contentCol"},Tt={key:0},Bt=h(()=>c("sup",null,"-6",-1)),Vt=["href"],It=["href"],Nt={class:"contentCol"},Ut={key:0,class:"pagiArea"},zt=h(()=>c("span",{class:"wrapperTip"},"Amount:",-1)),Lt=h(()=>c("span",{class:"wrapperTip"},"Price:",-1)),Wt=h(()=>c("span",{class:"wrapperTip"},"Amount:",-1)),Mt=h(()=>c("span",{class:"wrapperTip"},"Price:",-1));function Et(i,e,s,o,t,r){const y=p("el-option"),C=p("el-select"),A=p("el-space"),b=p("el-button"),W=p("el-card"),U=p("el-tab-pane"),m=p("el-table-column"),M=p("el-table"),E=p("el-pagination"),Y=p("el-tabs"),w=p("el-input"),k=p("el-form-item"),F=p("el-form"),q=p("el-dialog"),z=$("loading");return D(),_("div",dt,[t.bSignedIn?(D(),v(Y,{key:0,modelValue:t.activeTabName,"onUpdate:modelValue":e[7]||(e[7]=a=>t.activeTabName=a),size:"large",style:{"margin-top":"32px","text-align":"left"},onTabChange:r.onChangeTab},{default:l(()=>[n(U,{label:"Balance",name:"balance"},{default:l(()=>[n(A,{alignment:"center",style:{"margin-top":"8px"}},{default:l(()=>[gt,n(C,{modelValue:t.balanceData.curSip10Name,"onUpdate:modelValue":e[0]||(e[0]=a=>t.balanceData.curSip10Name=a),size:"large",filterable:"",placeholder:"Select",style:{width:"200px"}},{default:l(()=>[(D(!0),_(et,null,at(t.sip10NameList,a=>(D(),v(y,{key:a,label:a,value:a},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),pt,t.balanceData.loadState==2?(D(),_("div",Dt,[n(W,{shadow:"hover",class:"cardArea","body-style":{padding:"8px"}},{default:l(()=>[c("div",ht,u(t.balanceData.curStx10Name),1),c("div",mt,u(t.balanceData.stx10Balance),1),n(b,{class:"tokenBtn",type:"primary",disabled:t.balanceData.stx10Balance==0n,onClick:e[1]||(e[1]=a=>r.onClickWrapAndList())},{default:l(()=>[d("Wrap and list")]),_:1},8,["disabled"])]),_:1}),n(W,{shadow:"hover",class:"cardArea","body-style":{padding:"8px"}},{default:l(()=>[n(A,{class:"tokenName"},{default:l(()=>[bt,c("div",null,u(t.balanceData.curSip10Name),1)]),_:1}),c("div",ft,u(t.balanceData.sip10Balance/1000000n),1),n(b,{class:"tokenBtn",type:"primary",disabled:t.balanceData.sip10Balance==0n,onClick:e[2]||(e[2]=a=>r.onClickList())},{default:l(()=>[d("List")]),_:1},8,["disabled"])]),_:1})])):S("",!0),t.balanceData.loadState==1?L((D(),_("div",_t,null,512)),[[z,!0]]):S("",!0)]),_:1}),n(U,{label:"Listing",name:"listing"},{default:l(()=>[L((D(),v(M,{stripe:"",style:{width:"100%"},size:"large",data:t.listingData.tableData,"element-loading-background":"rgba(0, 0, 0, 0.4)","empty-text":t.listingData.loadState==2?"Empty":" "},{default:l(()=>[n(m,{label:"Amount",width:"150"},{default:l(a=>[c("div",St,u(a.row.amount),1)]),_:1}),n(m,{label:"Price",width:"120"},{default:l(a=>[n(A,{class:"contentCol"},{default:l(()=>[yt,d(" "+u(a.row.price/1000000n),1)]),_:2},1024)]),_:1}),n(m,{label:"Price unit",width:"250"},{default:l(a=>[c("div",Ct,[d(u(a.row.priceUnitStr)+" ",1),a.row.bPriceUnitSup?(D(),_("label",kt,[d(" x 10"),Pt])):S("",!0),c("span",null," STX/"+u(t.activityDatas.curWrapperToken),1)])]),_:1}),n(m,{label:"Action"},{default:l(a=>[n(b,{plain:"",onClick:J=>r.onClickChangePrice(a.row)},{default:l(()=>[d("Change price")]),_:2},1032,["onClick"]),n(b,{plain:"",onClick:J=>r.onClickCancel(a.row)},{default:l(()=>[d("Cancel list")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data","empty-text"])),[[z,t.listingData.loadState==1]]),t.listingData.totalCount>t.listingData.kPageSize?(D(),_("div",vt,[n(E,{disabled:t.listingData.loadState!=2,layout:"total, prev, pager, next, jumper","default-page-size":t.listingData.kPageSize,"current-page":t.listingData.curPage,"onUpdate:currentPage":e[3]||(e[3]=a=>t.listingData.curPage=a),total:t.listingData.totalCount,onCurrentChange:e[4]||(e[4]=a=>r.loadListingPage(t.listingData.curPage))},null,8,["disabled","default-page-size","current-page","total"])])):S("",!0)]),_:1}),n(U,{label:"Activity",name:"activity"},{default:l(()=>[L((D(),v(M,{stripe:"",style:{width:"100%"},size:"large",data:t.activityDatas.tableData,"element-loading-background":"rgba(0, 0, 0, 0.4)","empty-text":t.activityDatas.loadState==2?"Empty":" "},{default:l(()=>[n(m,{label:"Amount",width:"150"},{default:l(a=>[c("div",xt,u(a.row.amount),1)]),_:1}),n(m,{label:"Price",width:"120"},{default:l(a=>[n(A,{class:"contentCol"},{default:l(()=>[At,d(" "+u(a.row.price/1000000n),1)]),_:2},1024)]),_:1}),n(m,{label:"Price unit",width:"250"},{default:l(a=>[c("div",wt,[d(u(a.row.priceUnitStr)+" ",1),a.row.bPriceUnitSup?(D(),_("label",Tt,[d(" x 10"),Bt])):S("",!0),c("span",null," STX/"+u(t.activityDatas.curWrapperToken),1)])]),_:1}),n(m,{label:"Seller",width:"150px"},{default:l(a=>[c("a",{href:"https://explorer.hiro.so/address/"+a.row.seller+"?chain="+r._inGetNetType(),target:"_blank"},u(a.row.briefSeller),9,Vt)]),_:1}),n(m,{label:"Buyer",width:"150px"},{default:l(a=>[c("a",{href:"https://explorer.hiro.so/address/"+a.row.buyer+"?chain="+r._inGetNetType(),target:"_blank"},u(a.row.briefBuyer),9,It)]),_:1}),n(m,{label:"Time"},{default:l(a=>[c("div",Nt,u(a.row.timeStr),1)]),_:1})]),_:1},8,["data","empty-text"])),[[z,t.activityDatas.loadState==1]]),t.activityDatas.totalCount>t.activityDatas.kPageSize?(D(),_("div",Ut,[n(E,{disabled:t.activityDatas.loadState!=2,layout:"total, prev, pager, next, jumper","default-page-size":t.activityDatas.kPageSize,"current-page":t.activityDatas.curPage,"onUpdate:currentPage":e[5]||(e[5]=a=>t.activityDatas.curPage=a),total:t.activityDatas.totalCount,onCurrentChange:e[6]||(e[6]=a=>r.loadActivityPage(t.activityDatas.curPage))},null,8,["disabled","default-page-size","current-page","total"])])):S("",!0)]),_:1})]),_:1},8,["modelValue","onTabChange"])):S("",!0),t.bSignedIn?S("",!0):(D(),v(b,{key:1,type:"primary",size:"large",onClick:r.onClickSignIn},{default:l(()=>[d("Sign in to view")]),_:1},8,["onClick"])),n(q,{center:!0,title:t.listDialogData.title,modelValue:t.listDialogData.bVisible,"onUpdate:modelValue":e[10]||(e[10]=a=>t.listDialogData.bVisible=a),width:"500px"},{default:l(()=>[n(F,{class:"fcenter",ref:"form",model:t.listDialogData,"label-width":"100"},{default:l(()=>[n(k,null,{label:l(()=>[zt]),default:l(()=>[n(w,{modelValue:t.listDialogData.amountStr,"onUpdate:modelValue":e[8]||(e[8]=a=>t.listDialogData.amountStr=a),clearable:"",size:"large",placeholder:"Integer count"},{append:l(()=>[n(b,{type:"primary",onClick:r.onClickListMax},{default:l(()=>[d("Max")]),_:1},8,["onClick"])]),_:1},8,["modelValue"])]),_:1}),n(k,null,{label:l(()=>[Lt]),default:l(()=>[n(w,{modelValue:t.listDialogData.priceStr,"onUpdate:modelValue":e[9]||(e[9]=a=>t.listDialogData.priceStr=a),clearable:"",size:"large",placeholder:"Integer count"},{append:l(()=>[d(" STX ")]),_:1},8,["modelValue"])]),_:1}),n(k,null,{default:l(()=>[n(b,{type:"primary",onClick:r.onClickDialogList,disabled:!r.listBtnEnabled},{default:l(()=>[d(u(t.listDialogData.title),1)]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title","modelValue"]),n(q,{center:!0,title:"Change price",modelValue:t.changePriceDialogData.bVisible,"onUpdate:modelValue":e[13]||(e[13]=a=>t.changePriceDialogData.bVisible=a),width:"500px"},{default:l(()=>[n(F,{class:"fcenter",ref:"form",model:t.changePriceDialogData,"label-width":"100"},{default:l(()=>[n(k,null,{label:l(()=>[Wt]),default:l(()=>[n(w,{modelValue:t.changePriceDialogData.amountStr,"onUpdate:modelValue":e[11]||(e[11]=a=>t.changePriceDialogData.amountStr=a),clearable:"",disabled:"",size:"large",placeholder:"Integer count"},null,8,["modelValue"])]),_:1}),n(k,null,{label:l(()=>[Mt]),default:l(()=>[n(w,{modelValue:t.changePriceDialogData.priceStr,"onUpdate:modelValue":e[12]||(e[12]=a=>t.changePriceDialogData.priceStr=a),clearable:"",size:"large",placeholder:"Integer count"},{append:l(()=>[d(" STX ")]),_:1},8,["modelValue"])]),_:1}),n(k,null,{default:l(()=>[n(b,{type:"primary",onClick:r.onClickDialogChangePrice,disabled:!r.changePriceBtnEnabled},{default:l(()=>[d("Change price")]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}const jt=K(ut,[["render",Et],["__scopeId","data-v-ab27836b"]]);export{jt as default};
